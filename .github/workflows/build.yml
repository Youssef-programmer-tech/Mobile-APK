name: Build Android APK - Diagnostic

on: 
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        echo "=== Setting up environment ==="
        sudo apt update
        sudo apt install -y \
          python3 \
          python3-pip \
          python3-venv \
          git \
          wget \
          zip \
          unzip \
          openjdk-8-jdk \
          autoconf \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          cmake \
          libffi-dev \
          libssl-dev \
          ninja-build \
          curl
        
    - name: Show Python and Java versions
      run: |
        echo "Python version:"
        python3 --version
        echo "Java version:"
        java -version
        javac -version
        
    - name: Install Buildozer
      run: |
        python3 -m pip install --upgrade pip
        pip3 install buildozer cython virtualenv
        
    - name: Check project structure
      run: |
        echo "=== Project Structure ==="
        ls -la
        echo "=== Python files ==="
        find . -name "*.py" | head -20
        echo "=== Checking main.py ==="
        [ -f main.py ] && cat main.py || echo "main.py not found"
        echo "=== Checking App.py ==="
        [ -f App.py ] && head -20 App.py || echo "App.py not found"
        echo "=== Templates directory ==="
        ls -la Templates/ || echo "No Templates directory"
        
    - name: Initialize Buildozer
      run: |
        echo "=== Initializing Buildozer ==="
        if [ ! -f buildozer.spec ]; then
          buildozer init
        else
          echo "buildozer.spec already exists"
          cat buildozer.spec
        fi
        
    - name: Build APK with full logs
      run: |
        echo "=== Starting Build Process ==="
        buildozer android clean
        
        # Run build and capture output
        {
          buildozer android debug
        } 2>&1 | tee build.log || {
          echo "=== BUILD FAILED ==="
          echo "Last 50 lines of build log:"
          tail -50 build.log
          echo "=== Checking for common errors ==="
          grep -i "error\|fail\|exception" build.log | head -20
          exit 1
        }
        
    - name: Check build results
      run: |
        echo "=== Build Results ==="
        if [ -d bin ]; then
          echo "bin directory exists:"
          ls -la bin/
          find bin/ -name "*.apk" | head -10
        else
          echo "No bin directory created"
        fi
        
        if [ -d .buildozer ]; then
          echo "Buildozer logs:"
          find .buildozer -name "*.log" | head -10
        fi
        
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-diagnostics
        path: |
          build.log
          .buildozer/
        retention-days: 30
